# MDEV入門

オリジナル: busybox/docs/mdev.txt

mdevの使い方を知っている人にとっては入門書なんてつまらないものに思える
かもしれません。それ以外の人にとって、mdevは奇妙なブラックボックスであり、
すごいとは聞いてはいるがどう動くのか理解できないようです。だから入門書が
必要です。

## 基本的な用途

Mdevの主な用途は2つあります: 初期構築と動的更新です。 どちらもカーネルが
sysfsをサポートし、/sysにマウントされている必要があります。 動的更新の場合は
カーネルでホットプラグが有効になっている必要もあります。

以下はinitスクリプトの典型的なコードスニペットです。

```bash
[0] mount -t proc proc /proc
[1] mount -t sysfs sysfs /sys
[2] echo /sbin/mdev > /proc/sys/kernel/hotplug
[3] mdev -s
```

procfsがない場合は次のようになります。

```bash
[1] mount -t sysfs sysfs /sys
[2] sysctl -w kernel.hotplug=/sbin/mdev
[3] mdev -s
```

もちろん、より「完全な」セットアップをするには上のコードスニペットの前に
以下を実行する必要があります。

```bash
[4] mount -t tmpfs -o size=64k,mode=0755 tmpfs /dev
[5] mkdir /dev/pts
[6] mount -t devpts devpts /dev/pts
```

ここで簡単に説明すると、[1] mdevを実行する前に/sysをマウントしておく必要が
あります。そして、[2] デバイスが追加/削除されるたびに/sbin/mdevを実行する
ようにカーネルに指示し、デバイスノードが作成/破棄されるようにします。
次に、[3] システム起動の間に作成されたすべてのデバイスノードで/devを作成
します。

「完全な」セットアップの場合、[4] /devがtmpfsファイルシステムであることを
確認します（フラッシュで実行していると仮定します）。 次に、[5] /dev/pts
マウントポイントを作成し、最後に[6] devptsファイルシステムをマウントします。

## MDEV Config   (/etc/mdev.conf)

Mdevにはデフォルトのroot/root 660 以外のパーミッションが必要な場合に、
デバイスノードの所有権/パーミッションを制御するためのオプションの設定
ファイルがあります。

ファイルのフォーマットは次のとおりです。

```bash
	[-][envmatch]<device regex>	<uid>:<gid> <permissions>
or
	[envmatch]@<maj[,min1[-min2]]>	<uid>:<gid> <permissions>
or
	$envvar=<regex>		<uid>:<gid> <permissions>
```

たとえば:

```bash
	hd[a-z][0-9]* 0:3 660
```

configファイルの解析は最初にマッチした行で停止します。ただし、この行が
"-"で始まる場合は除きます。マッチする行がない場合はデフォルトの0:0 660が
使用されます。独自のデフォルトを設定するには次のように独自の全マッチを
作成するだけです。

```bash
	.* 1:1 777
```

次のオプションフィールドを使うことで、デバイスノードのrename/moveを行う
ことができます。

```bash
	<device regex> <uid>:<gid> <permissions> [=path]
```

デバイスノードをサブディレクトリに配置したい場合は必ずパスの末尾に/を
指定してください。デバイスノードの名前を変更したい場合は名前を指定する
だけです。

```bash
	hda 0:3 660 =drives/
```

これは"hda"を`drives/`サブディレクトリに移動します。

```bash
	hdb 0:3 660 =cdrom
```

これは "hdb"を"cdrom"にリネームします。

同様に、">path "はデバイスをrename/moveしますが、reanmed/movedした
デバイスへのシンボリックリンク`/dev/DEVNAME`も作成します。

また、4番目のフィールドに"!"を指定するとデバイスノードの作成を防ぐ
ことができます。

```bash
	tty[a-z]. 0:0 660 !
	pty[a-z]. 0:0 660 !
```

また、独自コマンドを実行できるようにした場合、ファイルは以下のような
形式になります。

```bash
	<device regex> <uid>:<gid> <permissions> [=path] [@|$|*<command>]
or
	<device regex> <uid>:<gid> <permissions> [>path] [@|$|*<command>]
or
	<device regex> <uid>:<gid> <permissions> [!] [@|$|*<command>]
```

例:

```
---8<---
# block devices
([hs]d[a-z])		root:disk	660	>disk/%1/0
([hs]d[a-z])([0-9]+)	root:disk	660	>disk/%1/%2
mmcblk([0-9]+)		root:disk	660	>disk/mmc/%1/0
mmcblk([0-9]+)p([0-9]+)	root:disk	660	>disk/mmc/%1/%2
# network devices
(tun|tap)		root:network	660	>net/%1
---8<---
```

特殊文字は次の意味を持ちます。

```bash
	@ デバイスの作成後に実行する
	$ デバイスを削除する前に実行する
	* デバイスの作成後、削除前の2回実行する
```

コマンドはsystem()関数経由で実行されます（つまり、コマンドをシェルに与える
ことになります）ので、/bin/shにシェルをインストールしておくことが必要です。
また、カーネルは標準入力、標準出力、標準エラーを/dev/nullに接続した状態で
ホットプラグヘルパーを実行することを忘れないでください。

便宜上、シェルの環境変数$MDEVにはデバイス名が設定されます。 したがって、
デバイス"hdc"がマッチした場合、MDEVは"hdc"に設定されます。

## ファームウェア

カーネルデバイスドライバの中にはデバイスを正しく初期化するために、実行時に
ファームウェアを要求する必要があるものがあります。そのようなファームウェア
ファイルはすべて`/lib/firmware/`ディレクトリに置いてください。 実行時に、
カーネルはファームウェアのファイル名でmdevを起動し、mdevは/lib/firmware/
からsysfsインターフェース経由でカーネルにロードします。正確なファイル名は
カーネルにハードコードされているので、ユーザ空間でのファイル名を知る必要が
ある場合はそこを見てください。

## シーケンス

カーネルはホットプラグイベントをシリアライズしません。連続したホットプラグの
呼び出しごとに環境変数 SEQNUM をインクリメントします。通常、mdevはそれを
無視します。このため、ホットプラグとホットアンプラグイベントの順番が入れ
替わり、デバイスノードが期待通りに作成されないという典型的な症状が発生する
ことがあります。

しかし、/dev/mdev.seqファイルがあると、mdevはその内容とSEQNUMを比較します。
最大2秒までリトライし、一致するのを待ちます。それらが完全に一致するか（
末尾の'\n'も許されません）、2秒が経過すると、mdevは通常通り実行し、
SEQNUM+1で/dev/mdev.seqを書き換えます。

つまり、これはmdevの並列起動をシリアライズします。

この機能を有効にするには、mdevをホットプラグハンドラに設定する前に
"echo >/dev/mdev.seq"を実行します。これによりファイルに'\n'が1つ
書き込まれます。
注意: mdevは単一の'\n'文字で構成されている/dev/mdev.seqを特殊なケースと
して認識します。つまり、最初のhotplugイベントが2秒間ストールすることは
ありません。
